<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­¡æ¨‚éŠæˆ²å³¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Nunito', 'Noto Sans TC', sans-serif;
        }
        
        .hidden {
            display: none !important;
        }

        /* ===== Main Menu Styles ===== */
        #mainMenu {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .game-card {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }
        .category-btn {
            transition: all 0.3s ease;
            border-radius: 15px;
            font-weight: 700;
        }
        .category-btn.active {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        .selector-btn { border-radius: 12px; transition: all 0.2s ease; font-weight: 600; }
        .selector-btn:hover { transform: scale(1.05); }
        .arrow-btn { border-radius: 50%; transition: all 0.2s ease; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .arrow-btn:hover { transform: scale(1.1); }
        .start-btn {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            border-radius: 25px;
            font-weight: 800;
            font-size: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }
        .start-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 35px rgba(255, 107, 107, 0.4); }
        .brain-icon { background: linear-gradient(45deg, #ff9a9e, #fecfef); }
        .mix-icon { background: linear-gradient(45deg, #a8edea, #fed6e3); }
        .body-icon { background: linear-gradient(45deg, #ffecd2, #fcb69f); }
        
        /* ===== General Game Session Styles ===== */
        .game-session-background {
             background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .button-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* ===== Fruit Game Styles ===== */
        .item-card { transition: all 0.3s ease-in-out; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .pulse-animation { animation: pulse 2s infinite; }
        .progress-bar { transition: width 0.1s linear; }
        
        /* ===== Tempo Game Styles ===== */
        #tempoGameContainer { color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .tempo-game-grid { width: 400px; height: 400px; position: relative; border: 4px solid white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); overflow: hidden; }
        .quadrant { position: absolute; width: 50%; height: 50%; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
        .quadrant-1 { top: 0; left: 0; background-color: #ff6b6b; border-bottom: 2px solid white; border-right: 2px solid white; }
        .quadrant-2 { top: 0; right: 0; background-color: #4ecdc4; border-bottom: 2px solid white; border-left: 2px solid white; }
        .quadrant-3 { bottom: 0; right: 0; background-color: #45b7d1; border-top: 2px solid white; border-left: 2px solid white; }
        .quadrant-4 { bottom: 0; left: 0; background-color: #96ceb4; border-top: 2px solid white; border-right: 2px solid white; }
        .quadrant.active { transform: scale(1.05); box-shadow: inset 0 0 50px rgba(255,255,255,0.5); filter: brightness(1.3); }
        .quadrant.dim { filter: brightness(0.4); }
        .star { position: absolute; transform: translate(-50%, -50%); font-size: 4rem; animation: starPulse 0.6s ease-in-out infinite alternate; z-index: 10; text-shadow: 2px 2px 8px rgba(0,0,0,0.5); }
        @keyframes starPulse { 0% { transform: translate(-50%, -50%) scale(1); } 100% { transform: translate(-50%, -50%) scale(1.2); } }
        .tempo-btn { padding: 12px 24px; border: none; border-radius: 25px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .tempo-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }

        /* ===== Aerobic Game Styles ===== */
        .video-container { position: relative; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-gray-100">

    <div id="mainMenu">
        <div class="container mx-auto px-4 py-8 relative z-10">
            <div class="text-center mb-12">
                <h1 class="text-6xl font-black text-white mb-4 drop-shadow-lg">ğŸ® æ­¡æ¨‚éŠæˆ²å³¶ ğŸ®</h1>
                <p class="text-2xl text-white/90 font-semibold">å‰µæ„å°éŠæˆ²å¤§é›†åˆ</p>
            </div>
            <div class="grid md:grid-cols-3 gap-8 mb-12">
                <div class="game-card p-6">
                    <div class="text-center mb-6">
                        <button class="category-btn brain-icon w-full py-4 px-6 text-white text-xl">ğŸ§  è…¦åŠ›æ¿€ç›ª (Brain)</button>
                    </div>
                    <div class="flex items-center justify-center space-x-4">
                        <button class="arrow-btn bg-pink-200 hover:bg-pink-300 text-pink-600" onclick="mainMenu.changeGame('brain', -1)">â—€</button>
                        <div id="brain-selector" class="selector-btn bg-gray-100 text-gray-500 px-6 py-3 min-w-[150px]">
                            è«‹é¸æ“‡éŠæˆ²
                        </div>
                        <button class="arrow-btn bg-pink-200 hover:bg-pink-300 text-pink-600" onclick="mainMenu.changeGame('brain', 1)">â–¶</button>
                    </div>
                    <div class="flex items-center justify-center space-x-4 mt-4">
                        <button class="arrow-btn bg-pink-200 hover:bg-pink-300 text-pink-600" onclick="mainMenu.changeTime('brain', -1)">â—€</button>
                        <div id="brain-time-selector" class="selector-btn bg-pink-100 text-pink-700 px-6 py-3 min-w-[150px] text-center"></div>
                        <button class="arrow-btn bg-pink-200 hover:bg-pink-300 text-pink-600" onclick="mainMenu.changeTime('brain', 1)">â–¶</button>
                    </div>
                </div>
                <div class="game-card p-6">
                    <div class="text-center mb-6">
                        <button class="category-btn mix-icon w-full py-4 px-6 text-white text-xl">ğŸ¯ ç¶œåˆæŒ‘æˆ° (Mix)</button>
                    </div>
                    <div class="flex items-center justify-center space-x-4">
                        <button class="arrow-btn bg-teal-200 hover:bg-teal-300 text-teal-600" onclick="mainMenu.changeGame('mix', -1)">â—€</button>
                        <div id="mix-selector" class="selector-btn bg-gray-100 text-gray-500 px-6 py-3 min-w-[150px]">
                            è«‹é¸æ“‡éŠæˆ²
                        </div>
                        <button class="arrow-btn bg-teal-200 hover:bg-teal-300 text-teal-600" onclick="mainMenu.changeGame('mix', 1)">â–¶</button>
                    </div>
                    <div class="flex items-center justify-center space-x-4 mt-4">
                        <button class="arrow-btn bg-teal-200 hover:bg-teal-300 text-teal-600" onclick="mainMenu.changeTime('mix', -1)">â—€</button>
                        <div id="mix-time-selector" class="selector-btn bg-teal-100 text-teal-700 px-6 py-3 min-w-[150px] text-center"></div>
                        <button class="arrow-btn bg-teal-200 hover:bg-teal-300 text-teal-600" onclick="mainMenu.changeTime('mix', 1)">â–¶</button>
                    </div>
                </div>
                <div class="game-card p-6">
                    <div class="text-center mb-6">
                        <button class="category-btn body-icon w-full py-4 px-6 text-white text-xl">ğŸƒ è‚¢é«”å”èª¿ (Body)</button>
                    </div>
                    <div class="flex items-center justify-center space-x-4">
                        <button class="arrow-btn bg-orange-200 hover:bg-orange-300 text-orange-600" onclick="mainMenu.changeGame('body', -1)">â—€</button>
                        <div id="body-selector" class="selector-btn bg-gray-100 text-gray-500 px-6 py-3 min-w-[150px]">
                            è«‹é¸æ“‡éŠæˆ²
                        </div>
                        <button class="arrow-btn bg-orange-200 hover:bg-orange-300 text-orange-600" onclick="mainMenu.changeGame('body', 1)">â–¶</button>
                    </div>
                    <div class="flex items-center justify-center space-x-4 mt-4">
                        <button class="arrow-btn bg-orange-200 hover:bg-orange-300 text-orange-600" onclick="mainMenu.changeTime('body', -1)">â—€</button>
                        <div id="body-time-selector" class="selector-btn bg-orange-100 text-orange-700 px-6 py-3 min-w-[150px] text-center"></div>
                        <button class="arrow-btn bg-orange-200 hover:bg-orange-300 text-orange-600" onclick="mainMenu.changeTime('body', 1)">â–¶</button>
                    </div>
                </div>
            </div>
            <div class="text-center">
                <button class="start-btn text-white px-12 py-6 hover:scale-105" onclick="gameManager.startSession()">ğŸš€ é–‹å§‹éŠæˆ² ğŸš€</button>
            </div>
        </div>
    </div>

    <div id="gameSession" class="hidden min-h-screen flex flex-col justify-center items-center p-4 game-session-background">

        <div id="gameHeader" class="w-full max-w-4xl mx-auto mb-4">
            <div class="bg-white rounded-2xl shadow-lg p-4">
                <div class="flex justify-between items-center">
                    <div class="text-xl font-semibold text-gray-700">
                        ç›®å‰éŠæˆ²: <span id="currentGameName" class="text-blue-600"></span>
                    </div>
                    <div class="text-xl font-semibold text-gray-700">
                        å‰©é¤˜æ™‚é–“: <span id="gameCountdownTimer" class="text-purple-600">00:00</span>
                    </div>
                    <button id="masterPauseBtn" onclick="gameManager.pauseCurrentGame()" class="bg-yellow-500 hover:bg-yellow-600 text-white text-lg font-semibold py-2 px-5 rounded-xl button-hover">
                        â¸ï¸ æš«åœ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <template id="template-say_the_fruit">
        <div id="say_the_fruitGameWrapper" class="game-wrapper hidden w-full max-w-4xl">
            <div class="max-w-4xl mx-auto px-4">
            
                <div id="fruitGameStartScreen" class="hidden text-center bg-white rounded-3xl shadow-lg p-8 mb-6">
                    <div class="mb-8">
                        <div class="text-6xl mb-4">ğŸ¯</div>
                        <h2 class="text-5xl font-bold text-orange-600 mb-2">æ°´æœå¿«èª</h1>
                        <p class="text-xl text-gray-600 mb-6">çœ‹åˆ°æ°´æœåœ–ç‰‡æ™‚ï¼Œè«‹å¤§è²èªªå‡ºæ°´æœçš„åç¨±</p>
                    </div>
                
                    <div class="mb-8">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-4">é¸æ“‡éŠæˆ²é€Ÿåº¦</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button data-difficulty="easy" class="difficulty-btn bg-green-500 hover:bg-green-600 text-white text-xl font-semibold py-4 px-6 rounded-2xl button-hover transition-all duration-300">
                                <div class="text-3xl mb-2">ğŸŒ</div>
                                ç°¡å–®æ¨¡å¼<br>
                                <span class="text-sm">3-5ç§’</span>
                            </button>
                            <button data-difficulty="medium" class="difficulty-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xl font-semibold py-4 px-6 rounded-2xl button-hover transition-all duration-300">
                                <div class="text-3xl mb-2">ğŸš¶</div>
                                ä¸­ç­‰æ¨¡å¼<br>
                                <span class="text-sm">2-3ç§’</span>
                            </button>
                            <button data-difficulty="hard" class="difficulty-btn bg-red-500 hover:bg-red-600 text-white text-xl font-semibold py-4 px-6 rounded-2xl button-hover transition-all duration-300">
                                <div class="text-3xl mb-2">ğŸƒ</div>
                                å›°é›£æ¨¡å¼<br>
                                <span class="text-sm">1-2ç§’</span>
                            </button>
                        </div>
                    </div>
                
                    <button id="fruitGameStartBtn" class="bg-orange-500 hover:bg-orange-600 text-white text-2xl font-bold py-4 px-12 rounded-2xl button-hover transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        é–‹å§‹éŠæˆ² ğŸ®
                    </button>
                </div>
            
                <div id="fruitGameMainScreen" class="hidden">
                    <div class="bg-white rounded-3xl shadow-lg p-8 text-center mb-6">
                        <div id="fruitDisplay" class="item-card">
                            </div>
                        <div class="flex justify-between items-center mb-4">
                            <div class="text-xl font-semibold text-gray-700">
                                æ¨¡å¼: <span id="currentMode" class="text-orange-600">ç°¡å–®</span>
                            </div>
                            <div class="text-xl font-semibold text-gray-700">
                                åœ–ç‰‡: <span id="imageCounter" class="text-blue-600">1</span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                            <div id="fruitProgressBar" class="progress-bar bg-orange-500 h-3 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            
            </div>
        </div>
    </template>

    <template id="template-say_the_animal">
        <div id="say_the_animalGameWrapper" class="game-wrapper hidden w-full max-w-4xl">
            <div class="max-w-4xl mx-auto px-4">

                <div id="animalGameStartScreen" class="hidden text-center bg-white rounded-3xl shadow-lg p-8 mb-6">
                    <div class="mb-8">
                        <div class="text-6xl mb-4">ğŸ¯</div>
                        <h2 class="text-5xl font-bold text-orange-600 mb-2">å‹•ç‰©å¿«èª</h1>
                        <p class="text-xl text-gray-600 mb-6">çœ‹åˆ°å‹•ç‰©åœ–ç‰‡æ™‚ï¼Œè«‹å¤§è²èªªå‡ºå‹•ç‰©çš„åç¨±</p>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-4">é¸æ“‡éŠæˆ²é€Ÿåº¦</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button data-difficulty="easy" class="difficulty-btn bg-green-500 hover:bg-green-600 text-white text-xl font-semibold py-4 px-6 rounded-2xl button-hover transition-all duration-300">
                                <div class="text-3xl mb-2">ğŸŒ</div>
                                ç°¡å–®æ¨¡å¼<br>
                                <span class="text-sm">3-5ç§’</span>
                            </button>
                            <button data-difficulty="medium" class="difficulty-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xl font-semibold py-4 px-6 rounded-2xl button-hover transition-all duration-300">
                                <div class="text-3xl mb-2">ğŸš¶</div>
                                ä¸­ç­‰æ¨¡å¼<br>
                                <span class="text-sm">2-3ç§’</span>
                            </button>
                            <button data-difficulty="hard" class="difficulty-btn bg-red-500 hover:bg-red-600 text-white text-xl font-semibold py-4 px-6 rounded-2xl button-hover transition-all duration-300">
                                <div class="text-3xl mb-2">ğŸƒ</div>
                                å›°é›£æ¨¡å¼<br>
                                <span class="text-sm">1-2ç§’</span>
                            </button>
                        </div>
                    </div>

                    <button id="animalGameStartBtn" class="bg-orange-500 hover:bg-orange-600 text-white text-2xl font-bold py-4 px-12 rounded-2xl button-hover transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        é–‹å§‹éŠæˆ² ğŸ®
                    </button>
                </div>

                <div id="animalGameMainScreen" class="hidden">
                    <div class="bg-white rounded-3xl shadow-lg p-8 text-center mb-6">
                        <div id="animalDisplay" class="item-card">
                            </div>
                        <div class="flex justify-between items-center mb-4">
                            <div class="text-xl font-semibold text-gray-700">
                                æ¨¡å¼: <span id="currentMode" class="text-orange-600">ç°¡å–®</span>
                            </div>
                            <div class="text-xl font-semibold text-gray-700">
                                åœ–ç‰‡: <span id="imageCounter" class="text-blue-600">1</span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                            <div id="animalProgressBar" class="progress-bar bg-orange-500 h-3 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </template>

    <template id="template-tempo_game">
        <div id="tempoGameWrapper" class="game-wrapper hidden w-full max-w-4xl flex flex-col items-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-6">ğŸµ ç¯€å¥æ‹æ‰‹éŠæˆ²</h1>
            <div id="tempoGameContainer" class="tempo-game-grid">
                <div class="quadrant quadrant-1">1</div>
                <div class="quadrant quadrant-2">2</div>
                <div class="quadrant quadrant-3">3</div>
                <div class="quadrant quadrant-4">4</div>
                <div class="star" id="star" style="display: none;">â­</div>
            </div>
             <div class="mt-6">
                <p class="text-lg text-gray-700">ğŸ¯ ç•¶æ˜Ÿæ˜Ÿå‡ºç¾æ™‚å¿«é€Ÿæ‹æ‰‹ï¼ (å¯æŒ‰ç©ºç™½éµ)</p>
            </div>
        </div>
    </template>

    <template id="template-aerobic_1">
        <div id="aerobicGameWrapper" class="game-wrapper hidden w-full max-w-4xl">
             <div class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-light text-gray-800">äº”è¡Œå¥åº·æ“</h1>
            </div>
            <div class="video-container">
                <video id="aerobicVideo" class="w-full h-full object-cover" controls>
                    <source src="video/äº”è¡Œå¥åº·æ“.mp4" type="video/mp4">
                    æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ’­æ”¾ã€‚
                </video>
            </div>
        </div>
    </template>

    <div id="sharedPauseScreen" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50">
        <div class="text-center bg-white rounded-3xl shadow-lg p-12">
            <div class="text-6xl mb-4">â¸ï¸</div>
            <h2 class="text-3xl font-bold text-gray-800 mb-8">éŠæˆ²æš«åœ</h2>
            <div class="flex gap-4 justify-center">
                <button onclick="gameManager.resumeCurrentGame()" class="bg-green-500 hover:bg-green-600 text-white text-xl font-semibold py-4 px-8 rounded-2xl button-hover">â–¶ï¸ ç¹¼çºŒ</button>
                <button onclick="gameManager.endSession()" class="bg-red-500 hover:bg-red-600 text-white text-xl font-semibold py-4 px-8 rounded-2xl button-hover">ğŸ  è¿”å›é¦–é </button>
            </div>
        </div>
    </div>

    <div id="sessionCompleteScreen" class="hidden fixed inset-0 bg-gradient-to-br from-green-300 to-blue-300 flex justify-center items-center z-50">
        <div class="text-center bg-white rounded-3xl shadow-2xl p-12 transform transition-all hover:scale-105 duration-500">
            <div class="text-7xl mb-6">ğŸ‰</div>
            <h2 class="text-4xl font-bold text-gray-800 mb-4">æ´»å‹•çµæŸï¼</h2>
            <p class="text-2xl text-gray-600 mb-10">æ‚¨å·²å®Œæˆä»Šæ—¥çš„æ‰€æœ‰éŠæˆ²ï¼Œåšå¾—å¤ªæ£’äº†ï¼</p>
            <button onclick="gameManager.returnToMenu()" class="bg-blue-500 hover:bg-blue-600 text-white text-2xl font-bold py-4 px-12 rounded-2xl button-hover">è¿”å›ä¸»é¸å–®</button>
        </div>
    </div>

    <script>
        // ===============================================================
        // ======================= LOAD GAME CLASSES =====================
        // ===============================================================
        async function initialize() {
            try {
                const gameClasses = await import('./game.js');
                window.FruitGame = gameClasses.FruitGame;
                window.AnimalGame = gameClasses.AnimalGame; // <-- æ–°å¢é€™ä¸€è¡Œ
                window.TempoGame = gameClasses.TempoGame;
                window.AerobicGame = gameClasses.AerobicGame;
                console.log("éŠæˆ²æ¨¡çµ„è¼‰å…¥æˆåŠŸï¼");
            } catch (error) {
                console.error('è¼‰å…¥æ¨¡çµ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                // å¯ä»¥åœ¨æ­¤è™•çµ¦ä½¿ç”¨è€…ä¸€å€‹æ›´å‹å–„çš„æç¤º
                alert('é—œéµéŠæˆ²æª”æ¡ˆè¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šä¸¦åˆ·æ–°é é¢ã€‚');
            }
        }

        initialize();

        


        // ===============================================================
        // =================== MAIN MENU & GAME MANAGER ==================
        // ===============================================================

        const mainMenu = {
            gameData: {
                brain: [ 
                    { id: 'say_the_fruit', name: 'æ°´æœå¿«èª' },
                    { id: 'say_the_animal', name: 'å‹•ç‰©å¿«èª' }
                 ],
                mix: [ { id: 'tempo_game', name: 'ç¯€å¥æ‹æ‰‹' } ],
                body: [ { id: 'aerobic_1', name: 'äº”è¡Œå¥åº·æ“' } ]
            },
            timeOptions: [
                { text: '5 Sec (Test)', value: 5 }, { text: '5 min', value: 300 },
                { text: '10 min', value: 600 }, { text: '15 min', value: 900 },
            ],
            selections: {
                brain: { gameIndex: -1, timeIndex: 1 },
                mix: { gameIndex: -1, timeIndex: 1 },
                body: { gameIndex: -1, timeIndex: 1 },
            },
            init() { this.updateAllDisplays(); },
            changeGame(category, direction) {
                const categoryGames = this.gameData[category];
                const current = this.selections[category];
                if (current.gameIndex === -1) {
                    if (direction === 1) { current.gameIndex = 0; }
                    else if (direction === -1) { current.gameIndex = categoryGames.length - 1; }
                } else {
                    current.gameIndex = (current.gameIndex + direction + categoryGames.length) % categoryGames.length;
                }
                this.updateDisplay(category);
            },
            changeTime(category, direction) {
                const current = this.selections[category];
                current.timeIndex = (current.timeIndex + direction + this.timeOptions.length) % this.timeOptions.length;
                this.updateDisplay(category);
            },
            updateDisplay(category) {
                const gameSelector = document.getElementById(`${category}-selector`);
                const timeSelector = document.getElementById(`${category}-time-selector`);
                const gameIndex = this.selections[category].gameIndex;
                const time = this.timeOptions[this.selections[category].timeIndex];
                if (gameIndex === -1) {
                    gameSelector.textContent = 'è«‹é¸æ“‡éŠæˆ²';
                } else {
                    const game = this.gameData[category][gameIndex];
                    gameSelector.textContent = game.name;
                    const colors = {
                        brain: 'bg-pink-100 text-pink-700',
                        mix: 'bg-teal-100 text-teal-700',
                        body: 'bg-orange-100 text-orange-700'
                    };
                    gameSelector.className = `selector-btn ${colors[category]} px-6 py-3 min-w-[150px]`;
                }
                timeSelector.textContent = time.text;
            },
            updateAllDisplays() { ['brain', 'mix', 'body'].forEach(cat => this.updateDisplay(cat)); },
            getSelectedConfig() {
                const config = {};
                for (const category of ['brain', 'mix', 'body']) {
                    const gameInfo = this.gameData[category][this.selections[category].gameIndex];
                    const timeInfo = this.timeOptions[this.selections[category].timeIndex];
                    config[category] = { id: gameInfo.id, name: gameInfo.name, time: timeInfo.value };
                }
                return config;
            }
        };


        const gameManager = {
            gameQueue: [],
            currentGameIndex: -1,
            activeGame: null,
            ui: {
                mainMenu: document.getElementById('mainMenu'),
                gameSession: document.getElementById('gameSession'),
                gameContainer: document.getElementById('gameSession'), 
                pauseScreen: document.getElementById('sharedPauseScreen'),
                completeScreen: document.getElementById('sessionCompleteScreen'),
                currentGameName: document.getElementById('currentGameName'),
            },

            // é€™å€‹å‡½å¼ä¿æŒä¸è®Š
            setupGameEventListeners(gameId) {
                if (gameId === 'say_the_fruit' || gameId === 'say_the_animal') {
                    const gameWrapper = document.getElementById(`${gameId.replace(/_(\d+)$/, '')}GameWrapper`);
                    if (!gameWrapper) return;

                    gameWrapper.querySelectorAll('.difficulty-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const clickedButton = e.target.closest('.difficulty-btn');
                            if (this.activeGame && typeof this.activeGame.setDifficulty === 'function') {
                                this.activeGame.setDifficulty(clickedButton.dataset.difficulty);
                            }
                        });
                    });

                    const startBtnId = gameId === 'say_the_fruit' ? 'fruitGameStartBtn' : 'animalGameStartBtn';
                    const startBtn = document.getElementById(startBtnId);
                    if (startBtn) {
                        startBtn.addEventListener('click', () => {
                            if (this.activeGame && typeof this.activeGame.confirmSettings === 'function') {
                                this.activeGame.confirmSettings();
                            }
                        });
                    }
                }
            },
            
            // é€™å€‹å‡½å¼ä¿æŒä¸è®Š
            loadGameUI(gameId) {
                const template = document.getElementById(`template-${gameId}`);
                if (!template) {
                    console.error(`æ‰¾ä¸åˆ° ID ç‚º "template-${gameId}" çš„ templateï¼`);
                    return null;
                }
                const gameClone = document.importNode(template.content, true);
                this.ui.gameContainer.appendChild(gameClone);
                this.setupGameEventListeners(gameId);
                // è¿”å›æ–°å»ºç«‹çš„ wrapper å…ƒç´ 
                return this.ui.gameContainer.querySelector('.game-wrapper:last-child');
            },
            
            // é€™å€‹å‡½å¼ä¿æŒä¸è®Š
            clearGameContainer() {
                const wrappers = this.ui.gameContainer.querySelectorAll('.game-wrapper');
                wrappers.forEach(wrapper => wrapper.remove());
            },

            // ===============================================================
            // =================== ä¸»è¦é‚è¼¯ä¿®æ”¹å€åŸŸ START ==================
            // ===============================================================
            startSession() {
                const selections = mainMenu.selections;
                if (selections.brain.gameIndex === -1 || selections.mix.gameIndex === -1 || selections.body.gameIndex === -1) {
                    alert('è«‹ç‚ºæ‰€æœ‰ä¸‰å€‹é¡åˆ¥éƒ½é¸æ“‡ä¸€å€‹éŠæˆ²ï¼');
                    return;
                }
                
                // æ­¥é©Ÿ 1: åªå»ºç«‹éŠæˆ²è¨­å®šçš„ä½‡åˆ—ï¼Œä¸è¼‰å…¥UIæˆ–å»ºç«‹å¯¦ä¾‹
                const config = mainMenu.getSelectedConfig();
                this.gameQueue = ['brain', 'mix', 'body'].map(category => config[category]);

                this.ui.mainMenu.classList.add('hidden');
                this.ui.gameSession.classList.remove('hidden');
                this.currentGameIndex = -1;
                this.startNextGame();
            },

            startNextGame() {
                // æ­¥é©Ÿ 2: å…ˆæ¸…é™¤ä¸Šä¸€å€‹éŠæˆ²çš„ç•«é¢
                this.clearGameContainer();

                this.currentGameIndex++;
                if (this.currentGameIndex < this.gameQueue.length) {
                    const gameData = this.gameQueue[this.currentGameIndex];
                    
                    // æ­¥é©Ÿ 3: è¼‰å…¥ç›®å‰é€™å€‹éŠæˆ²çš„UIï¼Œä¸¦å–å¾—å…¶å®¹å™¨å…ƒç´ 
                    const containerElement = this.loadGameUI(gameData.id);
                    if (!containerElement) {
                        console.error(`ç„¡æ³•ç‚º ${gameData.id} è¼‰å…¥éŠæˆ²UIï¼Œçµ‚æ­¢æµç¨‹ã€‚`);
                        this.endSession();
                        return;
                    }
                    
                    // æ­¥é©Ÿ 4: åœ¨UIè¼‰å…¥å¾Œï¼Œæ‰å»ºç«‹éŠæˆ²å¯¦ä¾‹
                    const gameConfig = {
                        id: gameData.id,
                        name: gameData.name, 
                        timeLimit: gameData.time, 
                        onComplete: () => this.startNextGame(),
                        containerEl: containerElement
                    };

                    let gameInstance;
                    switch (gameData.id) {
                        case 'say_the_fruit': 
                            gameInstance = new FruitGame(gameConfig); 
                            break;
                        case 'say_the_animal':
                            gameInstance = new AnimalGame(gameConfig);
                            break;
                        case 'tempo_game': 
                            gameInstance = new TempoGame(gameConfig); 
                            break;
                        case 'aerobic_1': 
                            gameInstance = new AerobicGame(gameConfig); 
                            break;
                    }

                    if (gameInstance) {
                         this.activeGame = gameInstance;
                         this.ui.currentGameName.textContent = this.activeGame.name;
                         this.activeGame.start();
                    }

                } else {
                    this.showCompletionScreen();
                }
            },

            // ===============================================================
            // =================== ä¸»è¦é‚è¼¯ä¿®æ”¹å€åŸŸ END ====================
            // ===============================================================

            endSession() {
                if (this.activeGame) { this.activeGame.stop(); }
                this.activeGame = null;
                this.gameQueue = [];
                this.ui.pauseScreen.classList.add('hidden');
                this.clearGameContainer(); // æ¸…ç†ç•«é¢
                this.returnToMenu();
            },

            showCompletionScreen() {
                 this.ui.gameSession.classList.add('hidden');
                 this.ui.completeScreen.classList.remove('hidden');
            },
            returnToMenu() {
                this.ui.gameSession.classList.add('hidden');
                this.ui.completeScreen.classList.add('hidden');
                this.ui.mainMenu.classList.remove('hidden');
            },
            pauseCurrentGame() {
                if (this.activeGame) {
                    this.activeGame.pause();
                    this.ui.pauseScreen.classList.remove('hidden');
                }
            },
            resumeCurrentGame() {
                if (this.activeGame) {
                    this.ui.pauseScreen.classList.add('hidden');
                    this.activeGame.resume();
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            mainMenu.init();
        });
    </script>

</body>
</html>